<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI.حللي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/jpg" href="Untitled design(1).jpg">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
            overflow-x: hidden; /* لمنع التمرير الأفقي */
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        .section-title {
            border-bottom: 2px solid #10B981;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .code-block {
            background-color: #D1FAE5;
            color: #047857;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-family: monospace;
            overflow-x: auto;
            direction: ltr;
            text-align: left;
        }
        .bg-gray-200 {
            background-color: #e5e7eb;
        }
        .table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            border: 1px solid #d1d5db;
            padding: 0.75rem;
            text-align: right;
        }
        th {
            background-color: #ECFDF5;
            font-weight: 600;
        }
        .nav-button {
            @apply px-4 py-2 rounded-md transition-colors duration-200;
        }
        .nav-button.active {
            @apply bg-emerald-800;
        }
        .nav-button:hover:not(.active) {
            @apply bg-emerald-600;
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .microphone-button {
            @apply bg-rose-600 hover:bg-rose-700 text-white p-3 rounded-full shadow-lg transition-transform duration-200 ease-in-out;
            transform: scale(1);
        }
        .microphone-button.listening {
            animation: pulse-ring 1.2s cubic-bezier(0.2, 0, 0, 0.8) infinite;
        }
        @keyframes pulse-ring {
            0% { transform: scale(0.9); }
            50% { transform: scale(1.1); }
            100% { transform: scale(0.9); }
        }
        .canvas-container {
            position: relative;
            background-color: #f3f4f6;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            touch-action: none;
        }
        #drawingCanvas {
            cursor: crosshair;
            max-width: 100%;
            height: auto;
        }
        .tool-button {
            transition: all 0.2s;
        }
        .tool-button.active {
            background-color: #3B82F6;
            color: #ffffff;
            border-color: #3B82F6;
        }
        .lock-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #059669;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease-in-out;
        }
        .lock-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .lock-card {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            color: #111827;
            max-width: 400px;
            width: 90%;
        }
        .lock-input {
            width: 100%;
            padding: 0.75rem;
            margin-top: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            border: 2px solid #d1d5db;
            background-color: #f9fafb;
            color: #111827;
            text-align: center;
            font-size: 1.25rem;
        }
        .lock-button {
            background-color: #10B981;
            color: #ffffff;
            font-weight: bold;
            padding: 0.75rem 2rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            width: 100%;
        }
        .lock-button:hover {
            background-color: #059669;
        }
        .lock-message {
            margin-top: 1rem;
            font-size: 1rem;
            height: 1.25rem;
        }
        .whatsapp-button {
            background-color: #000000;
            color: #ffffff;
            font-weight: bold;
            padding: 0.75rem 2rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            width: 100%;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .whatsapp-button:hover {
            background-color: #1DA851;
        }
        #gemini-response-container {
            direction: rtl; /* Use RTL for Arabic content */
            text-align: right;
            background-color: #f0fdf4;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            border: 1px solid #dcfce7;
            font-family: 'Inter', sans-serif;
        }
        #gemini-response-container h1, 
        #gemini-response-container h2, 
        #gemini-response-container h3 {
            font-weight: bold;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        #gemini-response-container ul,
        #gemini-response-container ol {
            list-style-position: inside;
            padding-right: 1.5rem;
            margin-bottom: 1rem;
        }
        #gemini-response-container ul {
            list-style-type: disc;
        }
        #gemini-response-container ol {
            list-style-type: decimal;
        }
        #gemini-response-container li {
            margin-bottom: 0.5rem;
        }
        #gemini-response-container p {
            margin-bottom: 1rem;
        }
        #gemini-response-container pre {
            background-color: #D1FAE5;
            color: #047857;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-family: monospace;
            overflow-x: auto;
            direction: ltr; /* Ensure code blocks are LTR */
            text-align: left;
        }
        #gemini-response-container code {
            font-family: monospace;
            background-color: #e5e7eb;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
        }
    </style>
</head>
<body class="antialiased">
    <div id="lock-screen" class="lock-screen">
        <div class="lock-card">
            <h2 class="text-3xl font-bold mb-4">أدخل رمز الدخول</h2>
            <input type="password" id="lock-code-input" class="lock-input" placeholder="الرمز السري">
            <button id="lock-submit-button" class="lock-button">دخول</button>
            
            <a href="https://wa.me/message/FT2PGIVRKUMVO1" class="whatsapp-button" target="_blank">
               
               تواصل معلي للحصول علي خصم 70% علي الموقع
            </a>

            <div id="lock-message" class="lock-message text-red-500"></div>
        </div>
    </div>

    <div id="main-content" class="hidden">
        <header class="bg-emerald-700 text-white py-4 rounded-b-xl shadow-lg">
            <div class="container flex flex-col md:flex-row items-center justify-between">
                <h1 class="text-4xl font-bold mb-4 md:mb-0">حللي.AI</h1>
                <nav>
                    <ul class="flex flex-wrap justify-center gap-2 md:gap-4">
                        <li><button class="nav-button active" data-target="home">الرئيسية</button></li>
                        <li><button class="nav-button" data-target="formulas">معادلات الإكسل</button></li>
                        <li><button class="nav-button" data-target="shortcuts">اختصارات الإكسل</button></li>
                        <li><button class="nav-button" data-target="problems">حلول مشاكل الإكسل</button></li>
                    </ul>
                </nav>
            </div>
        </header>

        <main class="container py-8">
            <section id="home" class="content-section active mb-12">
                <h2 class="text-3xl font-semibold section-title text-emerald-800">مرحباً بك في دليلك الشامل للإكسل!</h2>
                <div class="card">
                    <div class="flex flex-col md:flex-row items-center md:items-start gap-6 mb-6">
                        <div class="flex-shrink-0">
                            <img src="https://placehold.co/192x192/059669/ffffff?text=Ahmed" alt="[صورة أحمد العليمي يرتدي هودي أخضر]" class="w-48 h-48 object-cover rounded-full shadow-lg border-4 border-emerald-500">
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-emerald-700 mb-2">أحمد العليمي</h3>
                            <p class="text-lg mb-4">
                                أهلاً وسهلاً بك في هذا الموقع المتواضع، الذي يهدف إلى أن يكون مرجعك السريع والشامل لكل ما يتعلق ببرنامج مايكروسوفت إكسل.
                                اسمي أحمد العليمي، وأنا هنا لأشاركك خبرتي في هذا البرنامج القوي.
                            </p>
                            <p class="text-lg mb-4">
                                سواء كنت مبتدئاً تسعى لتعلم الأساسيات، أو مستخدماً متقدماً تبحث عن اختصارات ومعادلات لزيادة إنتاجيتك،
                                فقد صُمم هذا الدليل لمساعدتك. ستجد هنا شروحات وافية لأهم معادلات الإكسل،
                                وقائمة بأكثر الاختصارات استخداماً لتوفير وقتك وجهدك،
                                بالإضافة إلى حلول لبعض المشاكل الشائعة التي قد تواجهها أثناء عملك على البرنامج.
                            </p>
                            <p class="text-lg">
                                أتمنى أن تجد هذا الموقع مفيداً وأن يساعدك في إتقان إكسل والعمل عليه بكفاءة أكبر.
                                لا تتردد في استكشاف الأقسام المختلفة والاستفادة من المحتوى المقدم.
                            </p>
                        </div>
                    </div>
                    <div class="flex flex-wrap justify-center gap-4 mt-6">
                        <img src="https://placehold.co/160x160/059669/ffffff?text=Office" alt="[صورة أحمد العليمي في مكتب زجاجي]" class="w-40 h-40 object-cover rounded-lg shadow-md border-2 border-emerald-300">
                        <img src="https://placehold.co/160x160/059669/ffffff?text=Tablet" alt="[صورة أحمد العليمي يرتدي هودي أخضر ويحمل تابلت]" class="w-40 h-40 object-cover rounded-lg shadow-md border-2 border-emerald-300">
                    </div>
                </div>

                <div class="card mt-8">
                    <h3 class="text-2xl font-medium text-emerald-700 mb-3">✨ مولد ومحلل دوال الإكسل بالذكاء الاصطناعي ✨</h3>
                    <p class="mb-4">
                        اطلب من الذكاء الاصطناعي شرح أي دالة إكسل، أو اطلب منه إنشاء دالة بناءً على وصفك! يمكنك أيضاً إضافة صورة لتحليلها أو مشاركة شاشتك.
                    </p>

                    <div class="flex flex-col md:flex-row gap-2 mb-4">
                        <button id="screen-share-button" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200 shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L12 19.25L14.25 17M12 4.75L12 19.25M6 10L6 17.25L18 17.25L18 10"/>
                            </svg>
                            مشاركة الشاشة
                        </button>
                        <button id="stop-share-button" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200 shadow-md hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2A9 9 0 111 12a9 9 0 0118 0z" />
                            </svg>
                            إيقاف المشاركة
                        </button>
                        <button id="capture-frame-button" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200 shadow-md hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.84-1.549A2 2 0 0110.45 2h3.1a2 2 0 011.664.89l.84 1.549a2 2 0 001.664.89H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            التقاط صورة
                        </button>
                    </div>
                    <video id="screen-share-video" class="w-full rounded-md shadow-md mb-4 hidden" autoplay playsinline></video>
                    
                    <div class="mb-4">
                        <label for="image-upload" id="image-upload-label" class="flex items-center justify-center p-3 border border-dashed border-gray-300 rounded-md cursor-pointer hover:bg-gray-50 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                            </svg>
                            <span class="mr-2 text-sm text-gray-600">اختر صورة أو اسحبها هنا</span>
                            <input type="file" id="image-upload" class="hidden" accept="image/*">
                        </label>
                        <div id="drawing-container" class="canvas-container mt-4 hidden">
                            <canvas id="drawingCanvas"></canvas>
                        </div>
                        <div id="drawing-tools" class="flex flex-wrap justify-center gap-4 mt-6 p-4 bg-white rounded-xl shadow-md hidden">
                            <button id="drawLineButton" class="tool-button flex items-center gap-2 px-4 py-2 border rounded-full text-gray-700 hover:bg-gray-200 active">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L10 5.414 7.707 7.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                </svg>
                                خط
                            </button>
                            <button id="drawRectButton" class="tool-button flex items-center gap-2 px-4 py-2 border rounded-full text-gray-700 hover:bg-gray-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4V5h12v10z" clip-rule="evenodd" />
                                </svg>
                                مربع
                            </button>
                            <input type="color" id="colorPicker" value="#ef4444" class="w-12 h-12 rounded-full border-2 border-white cursor-pointer shadow-sm">
                            <button id="clearAnnotationsButton" class="px-4 py-2 border border-red-500 text-red-500 rounded-full hover:bg-red-500 hover:text-white transition-colors">
                                مسح الرسومات
                            </button>
                            <button id="clearImageButton" class="px-4 py-2 border border-red-500 text-red-500 rounded-full hover:bg-red-500 hover:text-white transition-colors">
                                إزالة الصورة
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center mb-4 relative">
                        <textarea id="ai-input" class="w-full h-[90px] p-3 pl-12 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500" rows="1" placeholder="مثال: كيف أجمع الأرقام في العمود A إذا كانت أكبر من 10؟ أو اشرح لي دالة VLOOKUP؟"></textarea>
                        <button id="voice-button" class="microphone-button absolute left-2 top-1/2 -translate-y-1/2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a4 4 0 00-4 4v2a4 4 0 004 4m0-12a4 4 0 014 4v2a4 4 0 01-4 4m0-12V4" />
                            </svg>
                        </button>
                    </div>
                    <button id="submit-button" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-md transition-colors duration-200 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        اسأل الذكاء الاصطناعي
                    </button>
                    
                    <div id="loading-indicator" class="mt-4 text-center text-emerald-700 hidden">
                        <svg class="animate-spin h-5 w-5 inline-block mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        جاري البحث...
                    </div>
                    <div id="gemini-response-container" class="mt-4 hidden"></div>
                </div>
            </section>

            <section id="formulas" class="content-section">
                <h2 class="text-3xl font-semibold section-title text-emerald-800">أهم معادلات الإكسل</h2>
                <div class="card">
                    <p class="text-lg">هذا القسم قيد الإنشاء. يمكنك استخدام خاصية الذكاء الاصطناعي لطلب أي معادلة تريدها.</p>
                </div>
            </section>
            
            <section id="shortcuts" class="content-section">
                <h2 class="text-3xl font-semibold section-title text-emerald-800">اختصارات الإكسل</h2>
                <div class="card">
                    <p class="text-lg">هذا القسم قيد الإنشاء. يمكنك استخدام خاصية الذكاء الاصطناعي لطلب أي اختصارات تريدها.</p>
                </div>
            </section>
            
            <section id="problems" class="content-section">
                <h2 class="text-3xl font-semibold section-title text-emerald-800">حلول مشاكل الإكسل</h2>
                <div class="card">
                    <p class="text-lg">هذا القسم قيد الإنشاء. يمكنك استخدام خاصية الذكاء الاصطناعي لطلب حل أي مشكلة تواجهك.</p>
                </div>
            </section>
        </main>
    </div>
    <footer class="bg-emerald-700 text-white text-center py-4 rounded-t-xl shadow-lg mt-8">
      <p>&copy; 2025 المحاسب الشاطر. جميع الحقوق محفوظة.</p>
  </footer>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const lockScreen = document.getElementById('lock-screen');
            const lockCodeInput = document.getElementById('lock-code-input');
            const lockSubmitButton = document.getElementById('lock-submit-button');
            const lockMessage = document.getElementById('lock-message');
            const mainContent = document.getElementById('main-content');
            
            const aiInput = document.getElementById('ai-input');
            const submitButton = document.getElementById('submit-button');
            const voiceButton = document.getElementById('voice-button');
            const loadingIndicator = document.getElementById('loading-indicator');
            const geminiResponseContainer = document.getElementById('gemini-response-container');

            const screenShareButton = document.getElementById('screen-share-button');
            const stopShareButton = document.getElementById('stop-share-button');
            const captureFrameButton = document.getElementById('capture-frame-button');
            const screenShareVideo = document.getElementById('screen-share-video');

            const imageUploadLabel = document.getElementById('image-upload-label');
            const imageUpload = document.getElementById('image-upload');
            const drawingContainer = document.getElementById('drawing-container');
            const drawingCanvas = document.getElementById('drawingCanvas');
            const drawingTools = document.getElementById('drawing-tools');
            const clearImageButton = document.getElementById('clearImageButton');
            
            const navButtons = document.querySelectorAll('.nav-button');
            const contentSections = document.querySelectorAll('.content-section');

            let stream = null;
            let capturedImage = null;
            const lockCodes = ['A1234123', 'B123B123', 'C000C000', 'M999M999', 'Y001U001']; // الرموز السرية

            // --- Canvas drawing setup ---
            let ctx = drawingCanvas.getContext('2d');
            let isDrawing = false;
            let currentTool = 'line';
            let startX, startY;
            let imageRatio = 1;

            const updateCanvasSize = (img) => {
                const containerWidth = drawingContainer.offsetWidth;
                drawingCanvas.width = containerWidth;
                drawingCanvas.height = img.height * (containerWidth / img.width);
                imageRatio = img.width / containerWidth;

                ctx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                ctx.drawImage(img, 0, 0, drawingCanvas.width, drawingCanvas.height);
                redrawAnnotations();
            };

            const resizeCanvas = () => {
                if (capturedImage) {
                    const img = new Image();
                    img.onload = () => updateCanvasSize(img);
                    img.src = capturedImage;
                }
            };
            window.addEventListener('resize', resizeCanvas);

            const getCanvasCoordinates = (event) => {
                const rect = drawingCanvas.getBoundingClientRect();
                const scaleX = drawingCanvas.width / rect.width;
                const scaleY = drawingCanvas.height / rect.height;
                let clientX, clientY;
                if (event.touches) {
                    clientX = event.touches[0].clientX;
                    clientY = event.touches[0].clientY;
                } else {
                    clientX = event.clientX;
                    clientY = event.clientY;
                }
                return {
                    x: (clientX - rect.left) * scaleX,
                    y: (clientY - rect.top) * scaleY
                };
            };
            
            let annotations = []; // Store annotations to redraw on resize

            const redrawAnnotations = () => {
                annotations.forEach(anno => {
                    ctx.beginPath();
                    ctx.strokeStyle = anno.color;
                    ctx.lineWidth = 3;
                    if (anno.type === 'line') {
                        ctx.moveTo(anno.points[0].x, anno.points[0].y);
                        ctx.lineTo(anno.points[1].x, anno.points[1].y);
                    } else if (anno.type === 'rect') {
                        ctx.rect(anno.points[0].x, anno.points[0].y, anno.points[1].x, anno.points[1].y);
                    }
                    ctx.stroke();
                });
            };

            drawingCanvas.addEventListener('mousedown', (e) => {
                isDrawing = true;
                const coords = getCanvasCoordinates(e);
                startX = coords.x;
                startY = coords.y;
            });
            drawingCanvas.addEventListener('touchstart', (e) => {
                isDrawing = true;
                const coords = getCanvasCoordinates(e);
                startX = coords.x;
                startY = coords.y;
                e.preventDefault(); // Prevent scrolling
            });

            drawingCanvas.addEventListener('mousemove', (e) => {
                if (!isDrawing) return;
                const coords = getCanvasCoordinates(e);
                ctx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                const img = new Image();
                img.src = capturedImage;
                ctx.drawImage(img, 0, 0, drawingCanvas.width, drawingCanvas.height);
                redrawAnnotations();
                ctx.beginPath();
                ctx.strokeStyle = document.getElementById('colorPicker').value;
                ctx.lineWidth = 3;
                if (currentTool === 'line') {
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(coords.x, coords.y);
                } else if (currentTool === 'rect') {
                    const width = coords.x - startX;
                    const height = coords.y - startY;
                    ctx.rect(startX, startY, width, height);
                }
                ctx.stroke();
            });
            drawingCanvas.addEventListener('touchmove', (e) => {
                if (!isDrawing) return;
                const coords = getCanvasCoordinates(e);
                ctx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                const img = new Image();
                img.src = capturedImage;
                ctx.drawImage(img, 0, 0, drawingCanvas.width, drawingCanvas.height);
                redrawAnnotations();
                ctx.beginPath();
                ctx.strokeStyle = document.getElementById('colorPicker').value;
                ctx.lineWidth = 3;
                if (currentTool === 'line') {
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(coords.x, coords.y);
                } else if (currentTool === 'rect') {
                    const width = coords.x - startX;
                    const height = coords.y - startY;
                    ctx.rect(startX, startY, width, height);
                }
                ctx.stroke();
                e.preventDefault();
            });

            const finalizeDrawing = (e) => {
                if (!isDrawing) return;
                isDrawing = false;
                const coords = getCanvasCoordinates(e);
                const endX = coords.x;
                const endY = coords.y;

                let newAnnotation;
                if (currentTool === 'line') {
                    newAnnotation = { type: 'line', color: document.getElementById('colorPicker').value, points: [{ x: startX, y: startY }, { x: endX, y: endY }] };
                } else if (currentTool === 'rect') {
                    const width = endX - startX;
                    const height = endY - startY;
                    newAnnotation = { type: 'rect', color: document.getElementById('colorPicker').value, points: [{ x: startX, y: startY }, { x: width, y: height }] };
                }
                annotations.push(newAnnotation);
                redrawAnnotations();
            };

            drawingCanvas.addEventListener('mouseup', finalizeDrawing);
            drawingCanvas.addEventListener('touchend', finalizeDrawing);

            // Set up tool buttons
            document.getElementById('drawLineButton').addEventListener('click', () => {
                currentTool = 'line';
                document.querySelectorAll('.tool-button').forEach(btn => btn.classList.remove('active'));
                document.getElementById('drawLineButton').classList.add('active');
            });
            document.getElementById('drawRectButton').addEventListener('click', () => {
                currentTool = 'rect';
                document.querySelectorAll('.tool-button').forEach(btn => btn.classList.remove('active'));
                document.getElementById('drawRectButton').classList.add('active');
            });
            document.getElementById('clearAnnotationsButton').addEventListener('click', () => {
                annotations = [];
                const img = new Image();
                img.onload = () => {
                    ctx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                    ctx.drawImage(img, 0, 0, drawingCanvas.width, drawingCanvas.height);
                };
                img.src = capturedImage;
            });
            document.getElementById('clearImageButton').addEventListener('click', () => {
                capturedImage = null;
                drawingContainer.classList.add('hidden');
                drawingTools.classList.add('hidden');
                imageUploadLabel.classList.remove('hidden');
                aiInput.placeholder = "مثال: كيف أجمع الأرقام في العمود A إذا كانت أكبر من 10؟ أو اشرح لي دالة VLOOKUP؟";
                annotations = [];
            });

            // --- Lock screen functionality ---
            lockSubmitButton.addEventListener('click', () => {
                if (lockCodes.includes(lockCodeInput.value)) {
                    lockScreen.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    // Store a flag in session storage to remember the user is logged in
                    sessionStorage.setItem('isLoggedIn', 'true');
                } else {
                    lockMessage.textContent = 'الرمز غير صحيح. يرجى المحاولة مرة أخرى.';
                    lockCodeInput.value = '';
                }
            });

            // Check if user is already logged in from previous session
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                lockScreen.classList.add('hidden');
                mainContent.classList.remove('hidden');
            }

            // --- Navigation functionality ---
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetId = button.dataset.target;
                    
                    navButtons.forEach(btn => btn.classList.remove('active', 'bg-emerald-800'));
                    button.classList.add('active', 'bg-emerald-800');
                    
                    contentSections.forEach(section => section.classList.remove('active'));
                    document.getElementById(targetId).classList.add('active');
                });
            });

            // --- AI Features ---
            async function callGeminiApi(prompt) {
                loadingIndicator.classList.remove('hidden');
                geminiResponseContainer.classList.add('hidden');

                const chatHistory = [];
                const parts = [{ text: prompt }];

                let finalImageBase64 = null;
                if (capturedImage) {
                    // Create a new canvas to merge the original image and annotations
                    const finalCanvas = document.createElement('canvas');
                    const img = new Image();
                    img.src = capturedImage;

                    await new Promise(resolve => img.onload = resolve);
                    
                    finalCanvas.width = img.width;
                    finalCanvas.height = img.height;
                    const finalCtx = finalCanvas.getContext('2d');
                    finalCtx.drawImage(img, 0, 0);

                    // Redraw annotations on the final canvas with correct scaling
                    const originalImageRatio = img.width / drawingCanvas.offsetWidth;
                    annotations.forEach(anno => {
                        finalCtx.beginPath();
                        finalCtx.strokeStyle = anno.color;
                        finalCtx.lineWidth = 3 * originalImageRatio; // Scale line width
                        if (anno.type === 'line') {
                            finalCtx.moveTo(anno.points[0].x * originalImageRatio, anno.points[0].y * originalImageRatio);
                            finalCtx.lineTo(anno.points[1].x * originalImageRatio, anno.points[1].y * originalImageRatio);
                        } else if (anno.type === 'rect') {
                            const scaledX = anno.points[0].x * originalImageRatio;
                            const scaledY = anno.points[0].y * originalImageRatio;
                            const scaledWidth = anno.points[1].x * originalImageRatio;
                            const scaledHeight = anno.points[1].y * originalImageRatio;
                            finalCtx.rect(scaledX, scaledY, scaledWidth, scaledHeight);
                        }
                        finalCtx.stroke();
                    });

                    finalImageBase64 = finalCanvas.toDataURL('image/png');
                    // Add the image part to the payload
                    parts.push({
                        inlineData: {
                            mimeType: "image/png",
                            data: finalImageBase64.split(',')[1]
                        }
                    });
                }
                
                chatHistory.push({ role: "user", parts: parts });
                
                const payload = { contents: chatHistory };
                const apiKey = "AIzaSyBog7ED0SHLMZ5myXy9OsQJB7fQrFQHpXI";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                let retries = 0;
                const maxRetries = 5;
                const initialDelay = 1000; // 1 second

                while (retries < maxRetries) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            if (response.status === 429) {
                                const delay = initialDelay * Math.pow(2, retries) + Math.random() * 1000;
                                console.warn(`API rate limit exceeded. Retrying in ${delay}ms...`);
                                await new Promise(res => setTimeout(res, delay));
                                retries++;
                                continue;
                            } else {
                                throw new Error(`API error: ${response.statusText}`);
                            }
                        }

                        const result = await response.json();
                        loadingIndicator.classList.add('hidden');
                        geminiResponseContainer.classList.remove('hidden');

                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            const text = result.candidates[0].content.parts[0].text;
                            // استخدام marked.js لتحويل تنسيقات Markdown إلى HTML
                            const html = marked.parse(text);
                            geminiResponseContainer.innerHTML = html;
                        } else {
                            geminiResponseContainer.textContent = 'حدث خطأ في الحصول على الرد من الذكاء الاصطناعي.';
                        }
                        return; // Exit the function after a successful call
                    } catch (error) {
                        console.error('Error calling Gemini API:', error);
                        loadingIndicator.classList.add('hidden');
                        geminiResponseContainer.classList.remove('hidden');
                        geminiResponseContainer.textContent = 'حدث خطأ غير متوقع. يرجى المحاولة مرة أخرى.';
                        return; // Exit the function after a final error
                    }
                }
            }

            // --- Submit button and AI interaction ---
            submitButton.addEventListener('click', () => {
                const prompt = aiInput.value;
                if (prompt.trim() === '') {
                    return;
                }
                
                callGeminiApi(prompt);
            });

            // --- Voice recognition ---
            if ('webkitSpeechRecognition' in window) {
                const recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.lang = 'ar-SA'; // Set language to Arabic
                recognition.interimResults = false;

                voiceButton.addEventListener('click', () => {
                    recognition.start();
                });

                recognition.addEventListener('start', () => {
                    voiceButton.classList.add('listening');
                    aiInput.placeholder = 'أستمع...';
                    aiInput.value = '';
                });

                recognition.addEventListener('result', (event) => {
                    const speechResult = event.results[0][0].transcript;
                    aiInput.value = speechResult;
                    aiInput.placeholder = 'مثال: كيف أجمع الأرقام في العمود A إذا كانت أكبر من 10؟';
                    // callGeminiApi(speechResult); // You can uncomment this line to automatically submit on speech result
                });

                recognition.addEventListener('end', () => {
                    voiceButton.classList.remove('listening');
                    aiInput.placeholder = 'مثال: كيف أجمع الأرقام في العمود A إذا كانت أكبر من 10؟';
                });

                recognition.addEventListener('error', (event) => {
                    console.error('Speech recognition error:', event.error);
                    aiInput.placeholder = 'حدث خطأ في التعرف على الصوت. يرجى المحاولة مرة أخرى.';
                    voiceButton.classList.remove('listening');
                });

            } else {
                voiceButton.classList.add('hidden');
                console.warn('Speech Recognition is not supported in this browser.');
            }

            // --- Screen sharing and capture ---
            screenShareButton.addEventListener('click', async () => {
                try {
                    stream = await navigator.mediaDevices.getDisplayMedia({
                        video: true
                    });
                    screenShareVideo.srcObject = stream;
                    screenShareVideo.classList.remove('hidden');
                    screenShareButton.classList.add('hidden');
                    stopShareButton.classList.remove('hidden');
                    captureFrameButton.classList.remove('hidden');
                } catch (err) {
                    console.error("Error: " + err);
                }
            });

            stopShareButton.addEventListener('click', () => {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    screenShareVideo.classList.add('hidden');
                    screenShareButton.classList.remove('hidden');
                    stopShareButton.classList.add('hidden');
                    captureFrameButton.classList.add('hidden');
                    stream = null;
                }
            });

            captureFrameButton.addEventListener('click', () => {
                if (screenShareVideo.srcObject) {
                    const tempCanvas = document.createElement('canvas');
                    const videoWidth = screenShareVideo.videoWidth;
                    const videoHeight = screenShareVideo.videoHeight;
                    tempCanvas.width = videoWidth;
                    tempCanvas.height = videoHeight;
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCtx.drawImage(screenShareVideo, 0, 0, videoWidth, videoHeight);

                    capturedImage = tempCanvas.toDataURL('image/png');
                    
                    const img = new Image();
                    img.onload = () => {
                        drawingContainer.classList.remove('hidden');
                        drawingTools.classList.remove('hidden');
                        imageUploadLabel.classList.add('hidden');
                        updateCanvasSize(img);
                        // Stop screen sharing after capturing
                        if (stream) {
                            stream.getTracks().forEach(track => track.stop());
                            screenShareVideo.classList.add('hidden');
                            screenShareButton.classList.remove('hidden');
                            stopShareButton.classList.add('hidden');
                            captureFrameButton.classList.add('hidden');
                            stream = null;
                        }
                    };
                    img.src = capturedImage;
                }
            });

            // --- Image upload ---
            imageUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        capturedImage = event.target.result;
                        const img = new Image();
                        img.onload = () => {
                            drawingContainer.classList.remove('hidden');
                            drawingTools.classList.remove('hidden');
                            imageUploadLabel.classList.add('hidden');
                            updateCanvasSize(img);
                        };
                        img.src = capturedImage;
                    };
                    reader.readAsDataURL(file);
                }
            });
        });
    </script>
</body>
</html>






